name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
      repository-projects: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Get current version
        id: get_version
        run: |
          $content = Get-Content PlayersModel.csproj -Raw
          if ($content -match '<Version>([^<]+)</Version>') {
            $VERSION = $matches[1]
          } else {
            $VERSION = "1.0.0"
          }
          Add-Content -Path $env:GITHUB_OUTPUT -Value "current_version=$VERSION"
          Write-Host "Current version: $VERSION"
        shell: pwsh
      
      - name: Calculate new version
        id: new_version
        run: |
          $CURRENT = "${{ steps.get_version.outputs.current_version }}"
          
          # Ëé∑ÂèñÊúÄÊñ∞ÁöÑtag
          try {
            $LATEST_TAG = git describe --tags --abbrev=0 2>$null
            $LATEST_TAG = $LATEST_TAG -replace '^v', ''
          } catch {
            $LATEST_TAG = "0.0.0"
          }
          
          # Ëß£ÊûêÁâàÊú¨Âè∑
          $CURRENT_PARTS = $CURRENT -split '\.'
          $MAJOR = [int]($CURRENT_PARTS[0] -or 1)
          $MINOR = [int]($CURRENT_PARTS[1] -or 0)
          $PATCH = [int]($CURRENT_PARTS[2] -or 0)
          
          # Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÂ¢ûÂä†ÁâàÊú¨Âè∑
          try {
            $null = git describe --exact-match --tags HEAD 2>$null
            Write-Host "Current commit already has a tag, skipping version bump"
            $NEW_VERSION = $CURRENT
          } catch {
            # Â¢ûÂä†Ë°•‰∏ÅÁâàÊú¨Âè∑
            $PATCH += 1
            $NEW_VERSION = "$MAJOR.$MINOR.$PATCH"
          }
          
          $TAG_NAME = "v$NEW_VERSION"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "new_version=$NEW_VERSION"
          Add-Content -Path $env:GITHUB_OUTPUT -Value "tag_name=$TAG_NAME"
          Write-Host "New version: $NEW_VERSION"
        shell: pwsh
      
      - name: Update version in csproj
        run: |
          $NEW_VERSION = "${{ steps.new_version.outputs.new_version }}"
          $content = Get-Content PlayersModel.csproj -Raw
          $content = $content -replace '<Version>[^<]+</Version>', "<Version>$NEW_VERSION</Version>"
          Set-Content PlayersModel.csproj -Value $content
          
          Write-Host "Updated PlayersModel.csproj with version $NEW_VERSION"
          Select-String -Path PlayersModel.csproj -Pattern "Version" | Select-Object -First 5
        shell: pwsh
      
      - name: Commit version update
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          $diff = git diff PlayersModel.csproj
          if ([string]::IsNullOrEmpty($diff)) {
            Write-Host "No version changes to commit"
          } else {
            git add PlayersModel.csproj
            git commit -m "chore: bump version to ${{ steps.new_version.outputs.new_version }}"
            git push
          }
        shell: pwsh
      
      - name: Build project
        run: dotnet build --configuration Release
      
      - name: Publish project
        run: dotnet publish PlayersModel.csproj --configuration Release --no-build
      
      - name: Prepare release artifact
        run: |
          if (Test-Path "build/publish/PlayersModel") {
            Copy-Item "build/publish/PlayersModel" -Destination "release-artifacts/PlayersModel" -Recurse -Force
          } elseif (Test-Path "build/publish") {
            New-Item "release-artifacts/PlayersModel" -ItemType Directory -Force
            Copy-Item "build/publish/*" -Destination "release-artifacts/PlayersModel" -Recurse -Force
          } else {
            Write-Error "Build output not found"
            exit 1
          }
          
          # ZIPÊñá‰ª∂Áî±.csprojÁöÑCreateZip TargetËá™Âä®ÁîüÊàê
          if (Test-Path "build/PlayersModel.zip") {
            Copy-Item "build/PlayersModel.zip" -Destination "release-artifacts/PlayersModel.zip" -Force
            Write-Host "ZIP created by MSBuild target"
            Get-Item "release-artifacts/PlayersModel.zip" | Select-Object FullName, Length
          } else {
            Write-Host "Note: ZIP will be created by the MSBuild CreateZip target"
          }
        shell: pwsh
      
      - name: Generate release notes
        id: release_notes
        run: |
          $VERSION = "${{ steps.new_version.outputs.tag_name }}"
          $REPO_URL = "${{ github.server_url }}/${{ github.repository }}"
          
          # Ëé∑Âèñ‰∏ä‰∏Ä‰∏™tag
          try {
            $PREVIOUS_TAG = git describe --tags --abbrev=0 HEAD^ 2>$null
            $TITLE = "PlayersModel $VERSION"
            $COMMIT_RANGE = "$PREVIOUS_TAG..HEAD"
          } catch {
            $TITLE = "PlayersModel $VERSION (Initial Release)"
            $COMMIT_RANGE = "HEAD"
          }
          
          # ÁîüÊàêÂèòÊõ¥Êó•Âøó
          $DESCRIPTION = "## üöÄ What's Changed`n`n"
          
          $logs = git log "$COMMIT_RANGE" --pretty=format:'%H%x09%s'
          foreach ($line in $logs) {
            if ([string]::IsNullOrWhiteSpace($line)) { continue }
            $parts = $line -split "`t"
            $COMMIT_SHA = $parts[0]
            $COMMIT_SUBJECT = $parts[1]
            $SHORT_SHA = $COMMIT_SHA.Substring(0, 7)
            $COMMIT_URL = "$REPO_URL/commit/$COMMIT_SHA"
            
            $LINE = "- $COMMIT_SUBJECT ([$SHORT_SHA]($COMMIT_URL))`n"
            $DESCRIPTION += $LINE
          }
          
          if ($DESCRIPTION -match "What's Changed`n$") {
            $DESCRIPTION += "- No significant changes in this release.`n"
          }
          
          $DESCRIPTION += "`n## üì¶ Installation`n`n"
          $DESCRIPTION += "1. Download ``PlayersModel.zip``"$"`n"
          $DESCRIPTION += "2. Extract to your SwiftlyS2 plugins directory`n"
          $DESCRIPTION += "3. Restart your server`n"
          
          # ‰øùÂ≠òÂà∞Êñá‰ª∂
          $TITLE | Out-File -FilePath release_title.txt -Encoding UTF8
          $DESCRIPTION | Out-File -FilePath release_description.txt -Encoding UTF8
          
          Write-Host "Release notes generated"
        shell: pwsh
      
      - name: Create Git Tag
        run: |
          $TAG_NAME = "${{ steps.new_version.outputs.tag_name }}"
          
          try {
            $null = git rev-parse $TAG_NAME 2>$null
            Write-Host "Tag $TAG_NAME already exists"
          } catch {
            git tag $TAG_NAME
            git push origin $TAG_NAME
            Write-Host "Created and pushed tag $TAG_NAME"
          }
        shell: pwsh
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TITLE = Get-Content release_title.txt -Raw
          $DESCRIPTION = Get-Content release_description.txt -Raw
          $TAG_NAME = "${{ steps.new_version.outputs.tag_name }}"
          
          # Ê£ÄÊü•releaseÊòØÂê¶Â∑≤Â≠òÂú®
          try {
            $null = gh release view $TAG_NAME 2>$null
            Write-Host "Release $TAG_NAME already exists, deleting..."
            gh release delete $TAG_NAME --yes
          } catch {
            Write-Host "Release doesn't exist yet, will create new one"
          }
          
          # ÂàõÂª∫Êñ∞release
          if (Test-Path "release-artifacts/PlayersModel.zip") {
            gh release create $TAG_NAME --title $TITLE --notes $DESCRIPTION "release-artifacts/PlayersModel.zip"
          } else {
            gh release create $TAG_NAME --title $TITLE --notes $DESCRIPTION
          }
          
          Write-Host "‚úÖ Release $TAG_NAME created successfully!"
        shell: pwsh
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PlayersModel-${{ steps.new_version.outputs.new_version }}
          path: release-artifacts/PlayersModel.zip
          retention-days: 30