name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths-ignore:
      - '**.md'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-and-release:
    runs-on: windows-latest
    permissions:
      contents: write
      repository-projects: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build project
        run: dotnet build --configuration Release
      
      - name: Publish project
        run: dotnet publish PlayersModel.csproj --configuration Release --no-build
      
      - name: Copy runtimes to publish output
        run: |
          $source = "build/net10.0/runtimes"
          $dest = "build/publish/PlayersModel/runtimes"
          
          if (Test-Path $source) {
            Copy-Item $source -Destination $dest -Recurse -Force
            Write-Host "Runtimes copied to publish output"
            Get-ChildItem $dest -Recurse | Measure-Object | Select-Object Count
          } else {
            Write-Host "Warning: runtimes directory not found"
          }
        shell: pwsh
      
      - name: Prepare release artifact
        run: |
          if (Test-Path "build/publish/PlayersModel") {
            Copy-Item "build/publish/PlayersModel" -Destination "release-artifacts/PlayersModel" -Recurse -Force
          } elseif (Test-Path "build/publish") {
            New-Item "release-artifacts/PlayersModel" -ItemType Directory -Force
            Copy-Item "build/publish/*" -Destination "release-artifacts/PlayersModel" -Recurse -Force
          } else {
            Write-Error "Build output not found"
            exit 1
          }
          
          # ZIPæ–‡ä»¶ç”±.csprojçš„CreateZip Targetè‡ªåŠ¨ç”Ÿæˆ
          if (Test-Path "build/PlayersModel.zip") {
            Copy-Item "build/PlayersModel.zip" -Destination "release-artifacts/PlayersModel.zip" -Force
            Write-Host "ZIP created by MSBuild target"
            Get-Item "release-artifacts/PlayersModel.zip" | Select-Object FullName, Length
          } else {
            Write-Host "Note: ZIP will be created by the MSBuild CreateZip target"
          }
        shell: pwsh
      
      - name: Generate release notes
        id: release_notes
        run: |
          $VERSION_TAG = "v1.0.6"
          $REPO_URL = "${{ github.server_url }}/${{ github.repository }}"
          
          # ç®€å•çš„å‘å¸ƒè¯´æ˜Ž
          $DESCRIPTION = "## ðŸ“¦ PlayersModel Release`n`n"
          $DESCRIPTION += "This is an automated release from GitHub Actions.`n`n"
          $DESCRIPTION += "### Features`n"
          $DESCRIPTION += "- Cookies integration for persistent model selection`n"
          $DESCRIPTION += "- Simplified single-model-per-player design`n"
          $DESCRIPTION += "- 3-tier model loading fallback system`n`n"
          $DESCRIPTION += "### Installation`n"
          $DESCRIPTION += "1. Download PlayersModel.zip`n"
          $DESCRIPTION += "2. Extract to your SwiftlyS2 plugins directory`n"
          $DESCRIPTION += "3. Restart your server`n"
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          "PlayersModel $VERSION_TAG" | Out-File -FilePath release_title.txt -Encoding UTF8
          $DESCRIPTION | Out-File -FilePath release_description.txt -Encoding UTF8
          
          Write-Host "Release notes generated"
        shell: pwsh
      
      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $TITLE = Get-Content release_title.txt -Raw
          $DESCRIPTION = Get-Content release_description.txt -Raw
          $TAG_NAME = "v1.0.6"
          
          # æ£€æŸ¥releaseæ˜¯å¦å·²å­˜åœ¨
          try {
            $null = gh release view $TAG_NAME 2>$null
            Write-Host "Release $TAG_NAME already exists, deleting..."
            gh release delete $TAG_NAME --yes
          } catch {
            Write-Host "Release doesn't exist yet, will create new one"
          }
          
          # åˆ›å»ºæ–°release
          if (Test-Path "release-artifacts/PlayersModel.zip") {
            gh release create $TAG_NAME --title $TITLE --notes $DESCRIPTION "release-artifacts/PlayersModel.zip"
          } else {
            gh release create $TAG_NAME --title $TITLE --notes $DESCRIPTION
          }
          
          Write-Host "âœ… Release $TAG_NAME created successfully!"
        shell: pwsh
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: PlayersModel-1.0.6
          path: release-artifacts/PlayersModel.zip
          retention-days: 30